puts File.open("in.txt") { |file, sum1 = 0, sum2 = 0| file.map { |line| [(l = line.strip.split(": "))[0].to_i, l[1].split(" ").map(&:to_i)] }.each { |target, v, found1 = false, found2 = false| (queue, len = [[v[0], 1, 1]], v.length - 1) and (0..).each { (break unless (last, i, pure = queue.pop)) or (add, mul, cat = last + (vi = v[i]), last * vi, last * (10 > vi ? 10 : (100 > vi ? 100 : 1000)) + vi) and (((queue.push([add, i + 1, pure]) if add < target or true) and (queue.push([mul, i + 1, pure]) if mul < target or true) and (queue.push([cat, i + 1, nil]) if cat < target or true) if i < len) or true) and (((found1 = (sum1 += target)) if (!found1 && pure && (add == target || mul == target))) || true) && ((found2 = (sum2 += target)) if (!found2 && (add == target || mul == target || cat == target))) || true and (break if found1 && found2) } } and [sum1, sum2] }