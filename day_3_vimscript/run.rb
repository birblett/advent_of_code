puts File.open("in.txt") { |file, p2 = ARGV.include?("2"), doo=true| file.map { |line| line.scan(/mul\([0-9]+,[0-9]+\)|don't\(\)|do\(\)/).map { |e| e.start_with?("do") ? e : e.scan(/[0-9]+/).map(&:to_i) } }.sum { |e| e.sum { |el| el == "don't()" ? ((doo = false || !p2) or 0 and 0) : (el == "do()" ? ((doo = true || !p2) or 0 and 0) : (doo) ? (el[0] * el[1]) : 0 ) } } }