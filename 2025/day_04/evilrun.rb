p ((grid = (grid, dirs, test = File.foreach("in.txt", chomp: true).map { |s| s.chars.map { |c| [c == "@" ? 1 : 0, 0 ] } }, [[0, -1], [-1, 0], [0, 1], [1, 0], [1, 1], [1, -1], [-1, 1], [-1, -1]])[0].each_with_index.map { |a, y, range = (0...a.length)| a.each_with_index.map { |b, x| [b[0], dirs.sum { |dy, dx, yy = (y + dy), xx = (x + dx)| range.include?(xx) && range.include?(yy) && grid[yy][xx][0] == 1 ? 1 : 0 }] } }).length..).reduce(0) { |s, _, marked = [], range = (0...grid.length)| s + (sum = (0...grid.length).sum { |y| (0...grid[0].length).sum { |x| grid[y][x][0] == 1 && grid[y][x][1] < 4 ? (marked.push([y, x]) and 1) : 0 } }) == s ? (break s) : s + (marked.each { |y, x| dirs.each { |dy, dx, yy = (y + dy), xx = (x + dx)| range.include?(xx) && range.include?(yy) ? grid[yy][xx][1] -= (grid[y][x][0] = 0) && grid[yy][xx][0] == 1 ? 1 : 0 : 0 } } && s == 0 ? (p sum) : sum) }